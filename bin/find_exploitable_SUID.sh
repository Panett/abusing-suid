#!/usr/bin/env sh

in_use_database="../resources/SUIDs_DB.bak.txt"
is_exploitable=0

make_indexed_DB() {
  curl --silent https://gtfobins.github.io/ \
    | grep "class=\"bin-name\"" `#grep della classe di interesse`  \
    | sed -e 's/^[ \t]*<td><a href=*//' `#Rimozione dell'apertura del tag e degli spazi-tab all'inizio della stringa` \
    | sed -e 's/class="bin-name">=*//'  `#Rimozione della parte riguardante la classe` \
    | sed -e 's/<\/a><\/td>*//' `#rimozione della chiusura dei tag` \
    | sed -e 's/*[ \t]$//' `#rimozione degli spazi alla fine` \
    | sed -e 's/^"*/\https:\/\/gtfobins.github.io/' `#aggiunta dell'url base per dare l'url assoluto` \
    | sed -e 's/"//' > ../resources/SUIDs_DB.txt #rimozione delle doppie virgolette e stampa su file

  if [ ! -s resources/SUIDs_DB.txt ]; then
    in_use_database="../resources/SUIDs_DB.txt"
  fi

  cat "$in_use_database" | awk '{print $2}'
}

make_exploitable_DB() {
  find / -user root -perm -4000 -print 2>/dev/null
}

echo "Populating internal SUIDs Database..."
indexed_DB=$(make_indexed_DB)

echo "Populating exploitable binaries Database..."
exploitables_DB=$(make_exploitable_DB)
total_exploit=0
for indexed_exploit in $indexed_DB; do

  if echo "$exploitables_DB" | grep "$indexed_exploit" > /dev/null; then
    echo "$exploitables_DB" | grep "$indexed_exploit" >> exploits.txt

    if [ $is_exploitable = 0 ]; then
        is_exploitable=1
    fi
  fi

done

if [ $is_exploitable = 0 ]; then
  echo "---------------------------"
  echo "NO exploitable SUIDs found."
else
  echo "------------------------------"
  echo "FOUND $total_exploit exploitable SUID(s)"
  echo "------------------------------"

  for exploit in $(cat exploits.txt); do
    search_exploit=$(echo "$exploit" | grep -Eo "[^\/]+$")

    found_exploit=$(cat "$in_use_database" | grep "$search_exploit")

    if [ "$found_exploit" != "" ]; then
      _sys_bin="$exploit"
      _url=$(echo "$found_exploit" | awk '{print $1}')
      _bin=$(echo "$found_exploit" | awk '{print $2}')

      echo "$_sys_bin $_url $_bin" >> output.txt
    fi
  done

  column -t -s' ' output.txt
  rm exploits.txt output.txt
fi

