#!/usr/bin/env sh

in_use_database="../resources/SUIDs_DB.bak.txt"
is_exploitable=0

make_indexed_DB() {
  curl --silent https://gtfobins.github.io/ \
    | grep "class=\"bin-name\""                       `# grep class of interest`  \
    | sed -e 's/^[ \t]*<td><a href=*//'               `# removing opening tags and whitespaces at the start` \
    | sed -e 's/class="bin-name">=*//'                `# removing class name` \
    | sed -e 's/<\/a><\/td>*//'                       `# removing closing tags` \
    | sed -e 's/*[ \t]$//'                            `# removing whitespaces at the end` \
    | sed -e 's/^"*/\https:\/\/gtfobins.github.io/'   `# adding url for generating absolute url` \
    | sed -e 's/"//' > ../resources/SUIDs_DB.txt       # removing double quotes and print on file

  if [ ! -s resources/SUIDs_DB.txt ]; then
    in_use_database="../resources/SUIDs_DB.txt"
  fi

  cat "$in_use_database" | awk '{print $2}'
}

make_exploitable_DB() {
  find / -user root -perm -4000 -print 2>/dev/null
}

echo "Populating internal SUIDs Database..."
indexed_DB=$(make_indexed_DB)

echo "Populating exploitable binaries Database..."
exploitables_DB=$(make_exploitable_DB)

for indexed_exploit in $indexed_DB; do

  if echo "$exploitables_DB" | grep "$indexed_exploit" > /dev/null; then
    echo "$exploitables_DB" | grep "$indexed_exploit" >> exploits.txt

    if [ $is_exploitable = 0 ]; then
        is_exploitable=1
    fi
  fi

done

if [ $is_exploitable = 0 ]; then
  echo "---------------------------"
  echo "NO exploitable SUIDs found."
else
  echo "------------------------------"
  echo "FOUND some exploitable SUID(s)"
  echo "------------------------------"

  for exploit in $(cat exploits.txt); do
    search_exploit=$(echo "$exploit" | grep -Eo "[^\/]+$")

    found_exploit=$(cat "$in_use_database" | grep "$search_exploit")

    if [ "$found_exploit" != "" ]; then
      _sys_bin="$exploit"
      _url=$(echo "$found_exploit" | awk '{print $1}')
      _bin=$(echo "$found_exploit" | awk '{print $2}')

      echo "$_sys_bin $_url $_bin" >> output.txt
    fi
  done

  column -t -s' ' output.txt
  rm exploits.txt output.txt
fi

